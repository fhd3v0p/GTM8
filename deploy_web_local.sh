#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è Flutter –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ web_local

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "üöÄ –ù–∞—á–∏–Ω–∞—é —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ Flutter –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."

# 1. –°–æ–∑–¥–∞—Ç—å production –±–∏–ª–¥
echo "üì¶ –°–æ–∑–¥–∞—é production –±–∏–ª–¥..."
flutter build web --release

# 2. –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –∏–∑ web_local
echo "üßπ –û—á–∏—â–∞—é —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã..."
rm -rf web_local/*

# 3. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –±–∏–ª–¥
echo "üìã –ö–æ–ø–∏—Ä—É—é –Ω–æ–≤—ã–π –±–∏–ª–¥ –≤ web_local..."
cp -r build/web/* web_local/

echo "üîß –ö–æ–ø–∏—Ä—É—é .env —Ñ–∞–π–ª –¥–ª—è production..."
cp assets/.env web_local/assets/assets/.env

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∑–∞–ø—É—â–µ–Ω –ª–∏ Docker
echo "üê≥ –ü—Ä–æ–≤–µ—Ä—è—é —Å–æ—Å—Ç–æ—è–Ω–∏–µ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
if docker ps | grep -q "gtm_nginx"; then
    echo "‚úÖ Nginx –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç"
    
    # 5. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å nginx –¥–ª—è –ø–æ–¥—Ö–≤–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é nginx –¥–ª—è –ø–æ–¥—Ö–≤–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π..."
    docker restart gtm_nginx
    
    echo "‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!"
    echo "üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å–∞–º:"
    echo "   - https://gtm.baby (production)"
    echo "   - http://localhost (–ª–æ–∫–∞–ª—å–Ω—ã–π Docker)"
else
    echo "‚ö†Ô∏è  Nginx –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω"
    echo "üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å Docker: docker-compose -f docker-compose-fixed.yml up -d"
fi

echo ""
echo "üìä –†–∞–∑–º–µ—Ä –±–∏–ª–¥–∞:"
du -sh web_local/
echo ""
echo "üéØ –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:"
echo "   flutter run -d chrome --web-port=8087"